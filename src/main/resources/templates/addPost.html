<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ذخیره پست</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


    <style>
        body {
            background: linear-gradient(135deg, #7bdab1, #ceacf1);
            direction: rtl;
        }

        header {
            background: linear-gradient(90deg, #9953cd, #613383);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo span:nth-child(odd) {
            color: #ffcb05;
            text-decoration: underline;
            text-decoration-color: #ffcb05;
        }

        .logo span:nth-child(even) {
            color: white;
            text-decoration: underline;
            text-decoration-color: white;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            letter-spacing: 1px;
        }

        nav a {
            margin: 0 12px;
            text-decoration: none;
            color: white;
            font-weight: 500;
            font-size: 16px;
            padding: 6px 10px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        nav a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                text-align: center;
            }

            nav {
                margin-top: 10px;
            }
        }

        .card {
            margin: 100px auto;
            border-radius: 16px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        .form-control::placeholder {
            font-style: italic;
            color: #999;
        }

        @keyframes shake {
            0% {
                transform: rotate(0deg);
            }
            25% {
                transform: rotate(-10deg);
            }
            50% {
                transform: rotate(10deg);
            }
            75% {
                transform: rotate(-10deg);
            }
            100% {
                transform: rotate(0deg);
            }
        }

    </style>
</head>
<body>

<div class="container">
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="errorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive"
             aria-atomic="true">
            <div class="d-flex align-items-center">
                <div class="toast-body" id="toastMessage">خطا رخ داده است</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                        aria-label="Close"></button>
            </div>
        </div>
    </div>

    <div class="card p-4 bg-light">
        <h3 class="text-center mb-4 text-primary fw-bold" id="formTitle">ذخیره پست</h3>
        <form id="postForm">
            <div class="mb-3">
                <label for="title" class="form-label">عنوان پست</label>
                <input type="text" class="form-control" id="title" placeholder="عنوان پست را وارد کنید...">
            </div>

            <div class="mb-3">
                <label for="content" class="form-label">محتوا</label>
                <textarea class="form-control" id="content" rows="5" placeholder="متن پست را بنویسید..."></textarea>
            </div>

            <div class="mb-3">
                <label for="author" class="form-label">نویسنده</label>
                <input type="text" class="form-control" id="author" placeholder="نام نویسنده را وارد کنید...">
            </div>

            <div class="mb-3">
                <label class="form-label">وضعیت</label>
                <select class="form-select" id="status">
                    <option value="DRAFT">پیش‌نویس</option>
                    <option value="PUBLISHED">منتشر شده</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="category" class="form-label">دسته‌بندی</label>
                <select class="form-select" id="category"></select>
            </div>

            <button type="submit" id="saveBtn"  class="btn btn-primary w-100 fw-bold">ذخیره</button>
        </form>

            <script>
                const params = new URLSearchParams(window.location.search);
                const postId = params.get("id");

                document.addEventListener("DOMContentLoaded", () => {
                    // گرفتن کتگوری‌ها از دیتابیس
                    fetch("http://localhost:8080/categories")
                        .then(res => res.json())
                        .then(categories => {
                            const categorySelect = document.getElementById("category");
                            categories.forEach(cat => {
                                const option = document.createElement("option");
                                option.value = cat.id;
                                option.textContent = cat.name;
                                categorySelect.appendChild(option);
                            });
                        });

                    // اگر حالت ویرایش بود:
                    if (postId) {
                        document.getElementById("saveBtn").innerText = "بروزرسانی پست";

                        fetch(`http://localhost:8080/posts/${postId}`)
                    .then(res => res.json())
                            .then(post => {
                                document.getElementById("title").value = post.title;
                                document.getElementById("content").value = post.content;
                                document.getElementById("author").value = post.author;
                                document.getElementById("status").value = post.status;
                                document.getElementById("category").value = post.categoryId;
                            });
                    }
                });

                document.getElementById("saveBtn").addEventListener("click", function (e) {
                    e.preventDefault();
                    if (postId) {
                        updatePost(postId);
                    } else {
                        savePost();
                    }
                });

                function savePost() {
                    const title = document.getElementById("title").value;
                    const content = document.getElementById("content").value;
                    const author = document.getElementById("author").value;
                    const status = document.getElementById("status").value;
                    const categoryId = document.getElementById("category").value;

                    fetch("http://localhost:8080/posts", {
                        method: "POST",
                        headers: {"Content-type": "application/json"},
                        body: JSON.stringify({title, content, author, status, categoryId})
                    })
                        .then(async res => {
                            if (!res.ok) {
                                const response = await res.json();
                                alert(response[0]?.title || "خطا در ثبت پست");
                                return;
                            }
                            return res.json();
                        })
                        .then(res => {
                            if (res) {
                                window.location.href = "http://localhost:8080/allpost";
                            }
                        });
                }

                function updatePost(id) {
                    const title = document.getElementById("title").value;
                    const content = document.getElementById("content").value;
                    const author = document.getElementById("author").value;
                    const status = document.getElementById("status").value;
                    const categoryId = document.getElementById("category").value;
                    fetch(`http://localhost:8080/posts/${id}`, {
                    method: "PUT",
                        headers: {"Content-type": "application/json"},
                    body: JSON.stringify({title, content, author, status, categoryId})
                })
                .then(async res => {
                    if (!res.ok) {
                        const response = await res.json();
                        alert(response[0]?.title || "خطا در بروزرسانی پست");
                        return;
                    }
                    return res.json();
                })
                    .then(res => {
                        if (res) {
                            window.location.href = "http://localhost:8080/";
                        }
                    });
                }
            </script>
  </body>
</html>
